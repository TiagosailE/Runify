<div class="min-h-screen bg-[#F5F5F5] pb-24">
  
  <%= render 'shared/header' %>

  <main class="px-6 py-8 space-y-6">
    
    <%= form_with model: current_user, url: profile_update_path, method: :patch, local: true, multipart: true, class: "space-y-6" do |f| %>
      
      <% if current_user.errors.any? %>
        <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-2xl p-4">
          <h3 class="text-sm font-semibold text-red-800 dark:text-red-200 mb-2">Erros encontrados:</h3>
          <ul class="text-sm text-red-700 dark:text-red-300 space-y-1">
            <% current_user.errors.full_messages.each do |message| %>
              <li>• <%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <div class="flex flex-col items-center">
        <div class="relative">
          <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-white dark:border-gray-700 shadow-lg">
            <img id="avatar-preview" src="<%= current_user.avatar_url %>" 
                 alt="Profile" 
                 class="w-full h-full object-cover">
          </div>
          <label for="avatar-input" class="absolute bottom-0 right-0 bg-teal-500 text-white w-10 h-10 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:bg-teal-600 transition-all">
            <i class="fas fa-camera"></i>
          </label>
          <%= f.file_field :avatar, id: "avatar-input", class: "hidden", accept: "image/*", onchange: "previewAvatar(event)" %>
        </div>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mt-4">
          <%= current_user.username || "Usuário" %>
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          <%= current_user.email %>
        </p>
      </div>

      <div class="space-y-4">
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome</label>
          <%= f.text_field :username, 
              value: current_user.username,
              placeholder: "Digite seu nome",
              class: "appearance-none block w-full px-4 py-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-gray-900 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-base" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Idade</label>
          <%= f.number_field :age, 
              value: current_user.age,
              placeholder: "Digite sua idade (12-120)",
              class: "appearance-none block w-full px-4 py-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-gray-900 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-base" %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mínimo 12, máximo 120 anos</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Peso (kg)</label>
          <%= f.number_field :weight, 
              value: current_user.weight,
              step: 0.1,
              placeholder: "Digite seu peso (30-300kg)",
              class: "appearance-none block w-full px-4 py-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-gray-900 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-base" %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mínimo 30kg, máximo 300kg</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Altura (cm)</label>
          <%= f.number_field :height, 
              value: current_user.height,
              placeholder: "Digite sua altura (100-250cm)",
              class: "appearance-none block w-full px-4 py-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-gray-900 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-base" %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mínimo 100cm, máximo 250cm</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Objetivo</label>
          <%= f.text_area :goal, 
              value: current_user.goal,
              rows: 4,
              placeholder: "Digite seu objetivo (ex: correr 10km em 50 minutos)",
              class: "appearance-none block w-full px-4 py-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-gray-900 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-base resize-none" %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Máximo 500 caracteres</p>
        </div>

      </div>

      <div class="pt-2">
        <%= f.submit "Editar perfil", 
            class: "w-full flex justify-center py-5 px-4 border border-transparent text-base font-semibold rounded-2xl text-white bg-teal-500 hover:bg-teal-600 focus:outline-none transition-all duration-200 shadow-lg cursor-pointer" %>
      </div>

    <% end %>

    <% if current_user.strava_connected? %>
      <div class="strava-card group relative overflow-hidden bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 p-5 flex items-center justify-between">
        <div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-500"></div>

        <div class="flex items-center gap-4">
          <div class="flex items-center justify-center w-12 h-12 bg-orange-50 dark:bg-orange-900/20 rounded-full shrink-0">
            <i class="fab fa-strava text-2xl text-[#FC4C02]"></i>
          </div>
          
          <div>
            <div class="flex items-center gap-2">
              <h3 class="font-bold text-gray-900 dark:text-gray-100">Strava Conectado</h3>
              <span class="flex h-2 w-2 relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">Sincronizado: <span class="font-mono text-xs opacity-90"><%= current_user.strava_integration.last_sync_at&.strftime('%d/%m/%Y %H:%M') || 'Nunca' %></span></p>
          </div>
        </div>

        <%= button_to strava_disconnect_path, method: :delete, class: "px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/40 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500/50" do %>
          Desconectar
        <% end %>
      </div>
    <% else %>
      <div class="strava-card group relative overflow-hidden bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 p-5">
        <div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-500"></div>

        <%= link_to strava_connect_path, data: { turbo: false }, class: "flex items-center justify-center gap-3 text-orange-600 dark:text-orange-400 font-semibold" do %>
          <div class="flex items-center justify-center w-12 h-12 bg-orange-50 dark:bg-orange-900/20 rounded-full">
            <i class="fab fa-strava text-2xl text-[#FC4C02]"></i>
          </div>
          <span>Conectar Strava</span>
        <% end %>
      </div>
    <% end %>

    <div class="pt-4">
      <button 
        type="button"
        onclick="showLogoutModal()"
        class="w-full flex justify-center py-4 px-4 border-2 border-red-500 text-base font-semibold rounded-2xl text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none transition-all duration-200 cursor-pointer">
        Sair
      </button>
    </div>

  </main>

  <%= render 'shared/footer' %>

  <!-- Formulário oculto para logout -->
  <%= form_with url: destroy_user_session_path, method: :delete, id: 'logout-form', class: 'hidden' do %>
  <% end %>

  <!-- Modal de confirmação de logout -->
<div id="logout-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6" style="backdrop-filter: blur(4px);">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-sign-out-alt text-3xl text-red-500"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Sair da conta?</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">Você precisará fazer login novamente para acessar sua conta.</p>
    </div>
    
    <div class="flex gap-3">
      <button 
        type="button"
        onclick="hideLogoutModal()" 
        class="flex-1 py-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        Não
      </button>
      <button 
        type="button"
        onclick="confirmLogout()" 
        class="flex-1 py-3 px-4 bg-red-500 hover:bg-red-600 rounded-xl text-white font-semibold transition-colors shadow-lg">
        Sim
      </button>
    </div>
  </div>
</div>

</div>

<script>
function previewAvatar(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('avatar-preview').src = e.target.result;
    }
    reader.readAsDataURL(file);
  }
}
</script>